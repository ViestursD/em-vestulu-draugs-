<?php
/**
 * embpd/utils/db.php
 * MySQL/MariaDB PDO konektors + tabulu inicializācija EM BPD modulim.
 *
 * DB: sql313.your-server.de / wp_addul_db1
 * Tabulas: embpd_* (lai nekrustojas ar WordPress wp_* tabulām)
 */

require_once __DIR__ . '/../.env.php';

/* =========================================================
   CONFIG
   ========================================================= */

// Te ieliec DB lietotāju/paroli (vari paņemt no wp-config.php)
const EMDB_HOST = 'jajg.your-database.de';
const EMDB_NAME = 'wp_a1';
const EMDB_USER = 'wp_';
const EMDB_PASS = 'TA';

// Tabulu prefikss mūsu modulim
const EMDB_PREFIX = 'embpd_';

/* =========================================================
   TABLE NAME CONSTANTS
   ========================================================= */
function t_chats(): string { return EMDB_PREFIX . 'chats'; }
function t_norm_prefs(): string { return EMDB_PREFIX . 'norm_prefs'; }
function t_intent_rules(): string { return EMDB_PREFIX . 'intent_rules'; }
function t_intent_suggestions(): string { return EMDB_PREFIX . 'intent_suggestions'; }

/* =========================================================
   PDO CONNECTION
   ========================================================= */
function db(): PDO {
  static $pdo = null;
  if ($pdo instanceof PDO) return $pdo;

  if (EMDB_USER === 'PASTE_DB_USER' || EMDB_PASS === 'PASTE_DB_PASSWORD') {
    throw new Exception("DB user/password nav iestatīts embpd/utils/db.php");
  }

  $dsn = "mysql:host=" . EMDB_HOST . ";dbname=" . EMDB_NAME . ";charset=utf8mb4";

  $pdo = new PDO($dsn, EMDB_USER, EMDB_PASS, [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
    PDO::ATTR_EMULATE_PREPARES => false,
  ]);

  init_db($pdo);
  return $pdo;
}

/* =========================================================
   INIT TABLES (MySQL)
   ========================================================= */
function init_db(PDO $pdo): void {

  // 1) Chats tabula
  $pdo->exec("
    CREATE TABLE IF NOT EXISTS `" . t_chats() . "` (
      `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
      `session_id` VARCHAR(64) NOT NULL,
      `role` VARCHAR(20) NOT NULL,
      `content` MEDIUMTEXT NOT NULL,
      `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      PRIMARY KEY (`id`),
      KEY `idx_session_created` (`session_id`, `created_at`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  ");

  // 2) Normatīvu failu izvēle (sesijas preferences)
  $pdo->exec("
    CREATE TABLE IF NOT EXISTS `" . t_norm_prefs() . "` (
      `session_id` VARCHAR(64) NOT NULL,
      `file` VARCHAR(255) NOT NULL,
      PRIMARY KEY (`session_id`, `file`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  ");

  // 3) Intent noteikumi (ēka / inženierbūve utt.)
  $pdo->exec("
    CREATE TABLE IF NOT EXISTS `" . t_intent_rules() . "` (
      `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
      `intent` VARCHAR(50) NOT NULL,
      `rule_type` VARCHAR(20) NOT NULL,   /* contains | regex */
      `pattern` VARCHAR(255) NOT NULL,
      `enabled` TINYINT(1) NOT NULL DEFAULT 1,
      `priority` INT NOT NULL DEFAULT 100,
      `note` VARCHAR(255) NULL,
      PRIMARY KEY (`id`),
      KEY `idx_intent_enabled` (`intent`, `enabled`, `priority`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  ");

  // 4) Intent ieteikumi (ko papildināt intent_rules)
  $pdo->exec("
    CREATE TABLE IF NOT EXISTS `" . t_intent_suggestions() . "` (
      `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
      `session_id` VARCHAR(64) NULL,
      `prompt` TEXT NOT NULL,
      `normalized` TEXT NOT NULL,
      `note` VARCHAR(255) NULL,
      `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
      `status` VARCHAR(20) NOT NULL DEFAULT 'new',
      PRIMARY KEY (`id`),
      KEY `idx_status_created` (`status`, `created_at`)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
  ");

  // 5) (Nav obligāti) Ieliekam bāzes intent_rules, ja tabula tukša
  $cnt = (int)$pdo->query("SELECT COUNT(*) AS c FROM `" . t_intent_rules() . "`")->fetchColumn();
  if ($cnt === 0) {
    $pdo->exec("
      INSERT INTO `" . t_intent_rules() . "` (`intent`,`rule_type`,`pattern`,`priority`,`note`) VALUES
      ('eka','contains','dzivojama eka',10,'ēka'),
      ('eka','contains','dzivojamo eka',20,'ēka'),
      ('eka','contains','eka',50,'ēka vispārīgi'),
      ('eka','regex','\\\\bmaj\\\\w*\\\\b',60,'māja, mājas, mājai...'),
      ('eka','contains','privatmaja',70,'privātmāja'),
      ('eka','contains','viena dzivokla',80,'viena dzīvokļa'),
      ('inzenierbuve','contains','inzenierbuve',10,'inženierbūve'),
      ('inzenierbuve','contains','inzenierbuv',20,'inženierbūves sakne');
    ");
  }
}

